---
- name: Install ansible module dependencies
  apt: pkg={{ item }} state=installed
  with_items:
    - python-pycurl
    - python-pip

- name: Set Ubuntu mirrors
  apt_repository: repo='{{ item }}' state=present
  with_items:
    - deb mirror://mirrors.ubuntu.com/mirrors.txt trusty main restricted universe multiverse
    - deb mirror://mirrors.ubuntu.com/mirrors.txt trusty-updates main restricted universe multiverse
    - deb mirror://mirrors.ubuntu.com/mirrors.txt trusty-security main restricted universe multiverse
    - deb mirror://mirrors.ubuntu.com/mirrors.txt trusty-backports main restricted universe multiverse

- name: Install necessities and nice-to-haves
  apt: pkg={{ item }} state=installed update_cache=yes
  with_items:
    - sudo
    - vim
    - htop
    - iftop
    - iotop
    - mosh
    - zsh
    - git
    - screen
    - ufw
    - curl
    - netcat
    - unzip

- name: Enable Textmate support
  get_url: url=https://raw.github.com/aurora/rmate/master/rmate dest=/usr/local/bin/rmate mode=0755

- name: Upgrade all safe packages
  apt: upgrade=safe update_cache=yes

- name: Create ssh temporary storage dir
  file: path={{ ssh.public_keys_dir }} state=directory

- name: Copy all ssh public keys to enable further processing
  copy: src=ssh/{{ item.name }}.pub dest={{ ssh.public_keys_dir }}/{{ item.name }}.pub
  with_items: users

- include: ntp.yml tags=ntp
- include: users.yml tags=users
- include: security.yml tags=security

- name: Cleanup ssh temporary storage dir
  file: path={{ ssh.public_keys_dir }} state=absent
